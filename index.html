<html>
    <head>
        <title>KRISS QT Backtester</title>
        <link rel="stylesheet" type="text/css" href="src/css/style.css"></script>
        <link rel="icon" href="src/img/favicon.ico" type="image/x-icon">
        <script type="text/javascript" src="src/js/utils.js"></script>
        <script type="text/javascript" src="src/js/promise_processing.js"></script>
        <script type="text/javascript" src="src/js/server_commute.js"></script>
        <script type="text/javascript" src="src/js/handleResponse.js"></script>
        <!-- apexcharts library -->
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <script type="text/javascript"> // crawling
            function updateCandle() {
                if (inputValidator() == false) return;
                
                let req_data = {
                    id: 0,
                    params: {},
                    tickers: []
                };
                let promises = [];
                let model = document.getElementById("model-select").value;
                let candle_size = document.getElementById("interval-select").value;
                // set keys
                let ticker_data = {};
                let ticker_objs = document.model_metadata[model].tickers;
                ticker_objs.map((ticker) => {ticker_data[ticker.id]=[];});

                // get param value
                setParamValues(candle_size, model, req_data.params);

                // request crawling
                ticker_objs.forEach((ticker) => {
                    let symbol = document.getElementById(ticker.id).value;
                    promises.push(
                        processCandle(symbol, candle_size)
                        .then((response) => {
                            ticker_data[ticker.id] = response;
                        }));
                });
                console.log(ticker_data);
                // make POST request
                Promise.all(promises).then(() => {
                    return postToBacktester(model, req_data, ticker_data);
                }).then((response) => {
                    handleResponse(response);
                });
                
            }
            async function processCandle(symbol, candle_size) {
                // convert datetime-local to timestamp
                let candle_length = intervalToTimestamp(candle_size);
                let start_time = new Date(document.getElementById("start-time").value).getTime();
                let end_time = new Date(document.getElementById("end-time").value).getTime();
                
                let max_iterations = Math.ceil((end_time - start_time) / (candle_length * 1000));
                
                let promises = [];
                let data_container = new Array(max_iterations);
                
                // adds all crawl promises
                updateDataContainter(symbol, candle_size, start_time, end_time, candle_length, promises, data_container);
                
                return Promise.all(promises).then(() => {
                    return data_container.flat();
                });
                };
        </script>
        <script type="text/javascript"> // model setting
            document.model_metadata = {};
            
            function updateParams() {
                let model = document.getElementById("model-select").value;
                // update params label and input
                let params = document.getElementById("params");
                params.innerHTML = "";
                for (const param of document.model_metadata[model].parameters) {
                    let label = document.createElement("label");
                    label.innerHTML = `<p title='${param.description}'>${param.displayName}:</p>`;
                    params.appendChild(label);
                    let input = document.createElement("input");
                    input.id = param.id;
                    input.value = param.defaultValue;
                    params.appendChild(input);
                    params.appendChild(document.createElement("br"));
                }
                // update symbols label and input
                let symbols = document.getElementById("symbols");
                symbols.innerHTML = "";
                for (const ticker of document.model_metadata[model].tickers) {
                    let label = document.createElement("label");
                    label.innerHTML = `<p title='${ticker.description}'>${ticker.displayName}:</p>`;
                    symbols.appendChild(label);
                    let input = document.createElement("input");
                    input.id = ticker.id;
                    input.value = ticker.defaultValue;
                    symbols.appendChild(input);
                    symbols.appendChild(document.createElement("br"));
                }
            }
            
            function loadModelMetadata() {
                fetch("/algoMetadata").then((response) => { // import metadata
                    return response.json();
                }).then((data) => {
                    document.model_metadata = data;
                    // set model select
                    for (const [key, value] of Object.entries(document.model_metadata)) {
                        let option = document.createElement("option");
                        option.value = key;
                        option.text = value.displayName;
                        model_select.appendChild(option);
                    }
                    // set default params
                    updateParams();
                    return data;
                });
            }
            loadModelMetadata();
        </script>
    </head>
    <body>
        <div id="container">
            <h1>KRISS QT Backtester</h1>
            <div>
                <label>Model: </label>
                <select id="model-select"></select><br>
                <label>Interval: </label>
                <select id="interval-select" value="15m">
                    <option value="1m">1m</option>
                    <option value="3m">3m</option>
                    <option value="5m">5m</option>
                    <option value="15m" selected="selected">15m</option>
                    <option value="30m">30m</option>
                    <option value="1h">1h</option>
                    <option value="2h">2h</option>
                    <option value="4h">4h</option>
                    <option value="6h">6h</option>
                    <option value="8h">8h</option>
                    <option value="12h">12h</option>
                    <option value="1d">1d</option>
                    <option value="3d">3d</option>
                    <option value="1w">1w</option>
                    <option value="1M">1M</option>
                </select><br>
                <div id="symbols"></div>
                <div id="params"></div>
                <label>Start Time: </label><input type="datetime-local" id="start-time"></input><br>
                <label>End Time: </label><input type="datetime-local" id="end-time"></input><br>
                <button class="button" id="button">Evaluate</button><br>
            </div>
            <!-- <p id="textbox">Nothing Yet</p> -->
            <div id="chart"></div>
        </div>
        <script src = ".\src\js\testData.js"> </script>
        <script>
            let button = document.getElementById("button"); 
            button.addEventListener("click", updateCandle);
            
            let model_select = document.getElementById("model-select");
            model_select.addEventListener("change", updateParams);
      
            var chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
        </script>
    </body>
</html>