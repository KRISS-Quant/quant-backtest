<html>
    <head>
        <title>KRISS QT Backtester</title>
        <link rel="stylesheet" type="text/css" href="src/css/style.css"></script>
        <link rel="icon" href="src/img/favicon.ico" type="image/x-icon">
        <script type="text/javascript" src="src/js/utils.js"></script>
        <script type="text/javascript"> // crawling
            function updateCandle() {
                let data = {};
                let promises = [];
                let model = document.getElementById("model-select").value;
                let candle = document.getElementById("interval-select").value;
                
                (document.model_metadata[model].tickers).forEach((ticker) => {
                    let symbol = document.getElementById(ticker.id).value;
                    promises.push(
                        processCandle(symbol, candle)
                        .then((response) => {
                            data[ticker.id] = response;
                        }));
                });
                Promise.all(promises).then(() => {
                    document.getElementById("textbox").innerText = new Date();
                    document.getElementById("data-container").innerHTML = "";
                    (document.model_metadata[model].tickers).forEach((ticker) => {
                        document.getElementById("data-container").innerHTML += data[ticker.id];
                    });
                });
            }
            async function processCandle(symbol, candle) {
                return getCandle(symbol, candle)
                    .then((response)=>{
                        let str = "<table><th>Time</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th>";
                        for (let param of response) {
                            let date = new Date(param[0]);
                            str += `<tr><td>${toTime(date)}</td>`;
                            for (let i=1; i<5; i++) {
                                str += `<td>${parseFloat(param[i]).toFixed(2)}</td>`;
                            }
                            str += `<td>${param[5]}</td></tr>`;
                        }
                        str += "</table>";
                        return str;
                    });
                };
        </script>
        <script type="text/javascript"> // model setting
            document.model_metadata = {};
            
            function updateParams() {
                let model = document.getElementById("model-select").value;
                // update params label and input
                let params = document.getElementById("params");
                params.innerHTML = "";
                for (const param of document.model_metadata[model].parameters) {
                    let label = document.createElement("label");
                    label.innerHTML = `<p title='${param.description}'>${param.displayName}:</p>`;
                    params.appendChild(label);
                    let input = document.createElement("input");
                    input.id = param.id;
                    input.value = param.defaultValue;
                    params.appendChild(input);
                    params.appendChild(document.createElement("br"));
                }
                // update symbols label and input
                let symbols = document.getElementById("symbols");
                symbols.innerHTML = "";
                for (const ticker of document.model_metadata[model].tickers) {
                    let label = document.createElement("label");
                    label.innerHTML = `<p title='${ticker.description}'>${ticker.displayName}:</p>`;
                    symbols.appendChild(label);
                    let input = document.createElement("input");
                    input.id = ticker.id;
                    input.value = ticker.defaultValue;
                    symbols.appendChild(input);
                    symbols.appendChild(document.createElement("br"));
                }
            }
            
            function loadModelMetadata() {
                fetch("/algoMetadata").then((response) => { // import metadata
                    return response.json();
                }).then((data) => {
                    document.model_metadata = data;
                    // set model select
                    for (const [key, value] of Object.entries(document.model_metadata)) {
                        let option = document.createElement("option");
                        option.value = key;
                        option.text = value.displayName;
                        model_select.appendChild(option);
                    }
                    // set default params
                    updateParams();
                    return data;
                });
            }
            loadModelMetadata();
        </script>
    </head>
    <body>
        <div id="container">
            <h1>KRISS QT Backtester</h1>
            <div>
                <label>Model: </label>
                <select id="model-select"></select><br>
                <label>Interval: </label>
                <select id="interval-select" value="15m">
                    <option value="1m">1m</option>
                    <option value="3m">3m</option>
                    <option value="5m">5m</option>
                    <option value="15m" selected="selected">15m</option>
                    <option value="30m">30m</option>
                    <option value="1h">1h</option>
                    <option value="2h">2h</option>
                    <option value="4h">4h</option>
                    <option value="6h">6h</option>
                    <option value="8h">8h</option>
                    <option value="12h">12h</option>
                    <option value="1d">1d</option>
                    <option value="3d">3d</option>
                    <option value="1w">1w</option>
                    <option value="1M">1M</option>
                </select><br>
                <div id="symbols"></div>
                <div id="params"></div>
                <label>Start Time: </label><input type="datetime-local" id="start-time"></input><br>
                <label>End Time: </label><input type="datetime-local" id="end-time"></input><br>
                <button class="button" id="button">Evaluate</button><br>
            </div>
            <p id="textbox">Nothing Yet</p>
            <div id="data-container"></div>
        </div>

        <script type="text/javascript">
            let button = document.getElementById("button"); 
            button.addEventListener("click", updateCandle);

            let model_select = document.getElementById("model-select");
            model_select.addEventListener("change", updateParams);
            
        </script>
    </body>
</html>